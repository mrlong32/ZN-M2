name: IPQ60XX-6.12-WIFI-ZN-M2
on:
  workflow_dispatch:
  schedule:
    - cron: 0 19 * * *
env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss
  CONFIG_FILE: configs/ipq60xx-6.12-wifi.config  
  DIY_SCRIPT: libwrt.sh
  CLASH_KERNEL: amd64
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false  
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: ZN-M2-IPQ60XX-6.12-WIFI  
  TZ: Asia/Shanghai
  DEVICE_NAME: zn-m2
jobs:
  Build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: 检查服务器性能
        run: |
          echo "警告⚠：分配的服务器性能有限，请确保仅编译 ZN-M2 固件"
          echo "CPU 核心信息：$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
          df -hT
      - name: 初始化环境（优化版）
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 精简清理：只删除关键冗余目录，避免全量卸载
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY &
          # 并行卸载：用 & 让卸载命令并行（按需保留必要卸载项）
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true &
          wait  # 等待并行任务完成
          sudo -E apt-get -y update
          # 安装依赖改用快速源（如用 ubuntu 官方源 + 预缓存关键包）
          sudo -E apt-get -y install build-essential git libncurses5-dev libz-dev unzip flex uglifyjs gcc-multilib g++-multilib p7zip-full libssl-dev texinfo device-tree-compiler
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo timedatectl set-timezone "$TZ"
      - name: 合并磁盘空间
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024
      # 后续 “检出代码”“克隆源代码” 等步骤保持原逻辑...
